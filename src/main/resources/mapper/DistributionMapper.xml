<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--namespace:映射命名空间-->
<mapper namespace="cn.hsf.hsf.mapper.user.DistributionMapper">

    <select id="selStatusById" resultType="cn.hsf.hsf.pojo.user.DistributionStatus">
        SELECT `id`, `statusName` FROM `tb_distribution_status` WHERE id = #{id}
    </select>
    <resultMap id="selOrderStatus" type="cn.hsf.hsf.pojo.user.Distribution">
        <id property="id" column="id"/>
        <result property="statusId" column="statusId"/>
        <result property="releaseId" column="releaseId"/>
        <association property="status" column="statusId" select="cn.hsf.hsf.mapper.user.DistributionMapper.selStatusById"/>
        <association property="userRelease" column="releaseId" select="cn.hsf.hsf.mapper.user.UserReleaseMapper.selReleaseById"/>
    </resultMap>

    <select id="selAllOrderBySfId" resultMap="selOrderStatus">
        SELECT `id`, `releaseId`, `statusId`, `refusedMessage`, `createTime`, `updateTime`, `sfId`, `orderId`
        FROM `tb_distribution`
        WHERE `sfId` = #{sfId}
    </select>
    
    <select id="selOrderById" resultMap="selOrderStatus">
        SELECT `id`, `releaseId`, `statusId`, `refusedMessage`, `createTime`, `updateTime`, `sfId`, `orderId`
        FROM `tb_distribution`
        WHERE `id` = #{id}
    </select>

<!--    Distribution selReleaseById(Integer releaseId); -->
    <select id="selReleaseById" resultType="int">
        SELECT COUNT(1)
        FROM `tb_distribution`
        WHERE `releaseId` = #{releaseId} AND (statusId = 2 OR statusId = 4 OR statusId = 6)
    </select>

    <!--     int updDistribution(Distribution distribution); -->
    <update id="updDistribution">
        UPDATE `tb_distribution`
        <set>
            <if test="statusId != null and statusId != ''">
                statusId = #{statusId},
            </if>
            <if test="refusedMessage != null and refusedMessage != ''">
                refusedMessage = #{refusedMessage},
            </if>
            <if test="orderId != null and orderId != ''">
                orderId = #{orderId},
            </if>
            updateTime = NOW()
        </set>
        <where>
             statusId = 1
            <if test="id != null and id != ''">
                and id = #{id}
            </if>
            <if test="releaseId != null and releaseId != ''">
                and releaseId = #{releaseId}
            </if>
        </where>
    </update>

    <update id="updDistribution2">
        UPDATE `tb_distribution`
        <set>
            <if test="statusId != null and statusId != ''">
                statusId = #{statusId},
            </if>
            <if test="refusedMessage != null and refusedMessage != ''">
                refusedMessage = #{refusedMessage},
            </if>
            <if test="orderId != null and orderId != ''">
                orderId = #{orderId},
            </if>
            updateTime = NOW()
        </set>
        <where>
            statusId = 2
            <if test="id != null and id != ''">
                and id = #{id}
            </if>
            <if test="releaseId != null and releaseId != ''">
                and releaseId = #{releaseId}
            </if>
        </where>
    </update>

    <!--   Distribution sel(UserRelease userRelease); -->
    <select id="sel" resultType="cn.hsf.hsf.pojo.user.Distribution">
        SELECT `id`, `releaseId`, `statusId`, `refusedMessage`, `createTime`, `updateTime`, `sfId`, `orderId`
        FROM `tb_distribution`
        WHERE releaseId = #{id} AND sfId = #{receiveId}
    </select>

    <!--     int insOrder(Distribution distribution); -->
    <insert id="insOrder" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `tb_distribution`(`id`, `releaseId`, `statusId`, `createTime`, `sfId`)
        VALUES(DEFAULT, #{releaseId}, #{statusId}, NOW(), #{sfId})
    </insert>

</mapper>